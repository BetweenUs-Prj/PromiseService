<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CORS í”„ë¦¬í”Œë¼ì´íŠ¸ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .result {
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left-color: #4CAF50; }
        .error { border-left-color: #f44336; }
        
        .curl-command {
            background: #2d2d2d;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .token-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ CORS í”„ë¦¬í”Œë¼ì´íŠ¸ í…ŒìŠ¤íŠ¸</h1>
        <p>UserService ì—°ë™ì„ ìœ„í•œ CORS ì„¤ì •ê³¼ í”„ë¦¬í”Œë¼ì´íŠ¸ ìš”ì²­ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
    </div>

    <div class="container">
        <h2>1. í”„ë¦¬í”Œë¼ì´íŠ¸ OPTIONS í…ŒìŠ¤íŠ¸</h2>
        <div class="test-section">
            <h3>ë¸Œë¼ìš°ì €ì—ì„œ í”„ë¦¬í”Œë¼ì´íŠ¸ í…ŒìŠ¤íŠ¸</h3>
            <p>ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ë³´ë‚´ëŠ” OPTIONS ìš”ì²­ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.</p>
            
            <button onclick="testPreflight()" class="btn btn-primary">í”„ë¦¬í”Œë¼ì´íŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button onclick="clearResults()" class="btn btn-secondary">ê²°ê³¼ ì§€ìš°ê¸°</button>
            
            <div id="preflightResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>curl ëª…ë ¹ì–´ë¡œ í”„ë¦¬í”Œë¼ì´íŠ¸ í…ŒìŠ¤íŠ¸</h3>
            <p>í„°ë¯¸ë„ì—ì„œ ì§ì ‘ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” curl ëª…ë ¹ì–´:</p>
            
            <div class="curl-command">curl -i -X OPTIONS 'http://localhost:8080/api/appointments/1/confirm' \
  -H 'Origin: http://localhost:8081' \
  -H 'Access-Control-Request-Method: POST' \
  -H 'Access-Control-Request-Headers: Authorization, Content-Type'</div>
            
            <p><strong>ê¸°ëŒ€ ì‘ë‹µ:</strong></p>
            <ul>
                <li><code>HTTP/1.1 200 OK</code></li>
                <li><code>Access-Control-Allow-Origin: http://localhost:8081</code></li>
                <li><code>Access-Control-Allow-Methods: POST</code></li>
                <li><code>Access-Control-Allow-Headers: Authorization, Content-Type</code></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>2. JWT ì¸ì¦ í…ŒìŠ¤íŠ¸</h2>
        <div class="test-section">
            <h3>JWT í† í° ì„¤ì •</h3>
            <p>í…ŒìŠ¤íŠ¸ìš© JWT í† í°ì„ ì…ë ¥í•˜ê±°ë‚˜ ìë™ ìƒì„±í•˜ì„¸ìš”:</p>
            
            <input type="text" id="jwtToken" class="token-input" 
                   placeholder="JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwicm9sZSI6IlVTRVIifQ.test)"
                   value="">
            
            <button onclick="generateTestToken()" class="btn btn-secondary">í…ŒìŠ¤íŠ¸ í† í° ìƒì„±</button>
            <button onclick="saveTokenToStorage()" class="btn btn-primary">localStorageì— ì €ì¥</button>
            <button onclick="loadTokenFromStorage()" class="btn btn-secondary">localStorageì—ì„œ ë¡œë“œ</button>
        </div>

        <div class="test-section">
            <h3>API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (CORS + JWT)</h3>
            <p>ì‹¤ì œ API ìš”ì²­ì„ ë³´ë‚´ì„œ CORSì™€ JWT ì¸ì¦ì´ ëª¨ë‘ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
            
            <button onclick="testConfirmAppointment()" class="btn btn-success">ì•½ì† í™•ì • API í…ŒìŠ¤íŠ¸</button>
            <button onclick="testGetParticipants()" class="btn btn-primary">ì°¸ì—¬ì ì¡°íšŒ API í…ŒìŠ¤íŠ¸</button>
            <button onclick="testWithoutToken()" class="btn btn-warning">í† í° ì—†ì´ API í˜¸ì¶œ</button>
            <button onclick="testWithInvalidToken()" class="btn btn-danger">ì˜ëª»ëœ í† í°ìœ¼ë¡œ API í˜¸ì¶œ</button>
            
            <div id="apiResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>3. í¬ë¡œìŠ¤ ë„ë©”ì¸ ì‹œë®¬ë ˆì´ì…˜</h2>
        <div class="test-section">
            <h3>UserService(8081)ì—ì„œ PromiseService(8080) í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜</h3>
            <p>ì‹¤ì œ UserServiceì—ì„œ í˜¸ì¶œí•˜ëŠ” ê²ƒì²˜ëŸ¼ Origin í—¤ë”ë¥¼ ì„¤ì •í•´ì„œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            
            <button onclick="testCrossOrigin()" class="btn btn-primary">í¬ë¡œìŠ¤ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸</button>
            
            <div id="crossOriginResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showResult(elementId, title, data, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const resultClass = isError ? 'error' : 'success';
            
            const resultText = `[${timestamp}] ${title}\n${JSON.stringify(data, null, 2)}\n\n`;
            
            if (element.style.display === 'none') {
                element.textContent = resultText;
            } else {
                element.textContent = resultText + element.textContent;
            }
            
            element.style.display = 'block';
            element.className = `result ${resultClass}`;
            element.scrollTop = 0;
        }

        // ê²°ê³¼ ì§€ìš°ê¸°
        function clearResults() {
            ['preflightResult', 'apiResult', 'crossOriginResult'].forEach(id => {
                const element = document.getElementById(id);
                element.textContent = '';
                element.style.display = 'none';
            });
        }

        // í”„ë¦¬í”Œë¼ì´íŠ¸ í…ŒìŠ¤íŠ¸
        async function testPreflight() {
            try {
                showResult('preflightResult', 'í”„ë¦¬í”Œë¼ì´íŠ¸ ìš”ì²­ ì‹œì‘...', { status: 'loading' });
                
                const response = await fetch('http://localhost:8080/api/appointments/1/confirm', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': 'http://localhost:8081',
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Authorization, Content-Type'
                    }
                });

                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });

                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: headers
                };

                showResult('preflightResult', 'âœ… í”„ë¦¬í”Œë¼ì´íŠ¸ ì„±ê³µ', result);

            } catch (error) {
                showResult('preflightResult', 'âŒ í”„ë¦¬í”Œë¼ì´íŠ¸ ì‹¤íŒ¨', { 
                    error: error.message,
                    type: error.constructor.name 
                }, true);
            }
        }

        // í…ŒìŠ¤íŠ¸ í† í° ìƒì„±
        function generateTestToken() {
            // ê°„ë‹¨í•œ JWT í˜•íƒœì˜ í…ŒìŠ¤íŠ¸ í† í° ìƒì„±
            const header = btoa(JSON.stringify({alg: "HS256", typ: "JWT"}));
            const payload = btoa(JSON.stringify({sub: "1", role: "USER", exp: Date.now() + 3600000}));
            const signature = "test_signature_" + Math.random().toString(36).substr(2, 9);
            
            const testToken = `${header}.${payload}.${signature}`;
            document.getElementById('jwtToken').value = testToken;
            
            showResult('apiResult', 'í…ŒìŠ¤íŠ¸ í† í° ìƒì„±ë¨', { 
                token: testToken.substring(0, 50) + '...',
                length: testToken.length 
            });
        }

        // localStorageì— í† í° ì €ì¥
        function saveTokenToStorage() {
            const token = document.getElementById('jwtToken').value;
            if (token) {
                localStorage.setItem('jwt', token);
                showResult('apiResult', 'JWT í† í° ì €ì¥ë¨', { 
                    saved: true, 
                    length: token.length 
                });
            } else {
                showResult('apiResult', 'ì €ì¥í•  í† í°ì´ ì—†ìŠµë‹ˆë‹¤', {}, true);
            }
        }

        // localStorageì—ì„œ í† í° ë¡œë“œ
        function loadTokenFromStorage() {
            const token = localStorage.getItem('jwt');
            if (token) {
                document.getElementById('jwtToken').value = token;
                showResult('apiResult', 'JWT í† í° ë¡œë“œë¨', { 
                    loaded: true, 
                    length: token.length 
                });
            } else {
                showResult('apiResult', 'localStorageì— í† í°ì´ ì—†ìŠµë‹ˆë‹¤', {}, true);
            }
        }

        // ì•½ì† í™•ì • API í…ŒìŠ¤íŠ¸
        async function testConfirmAppointment() {
            try {
                const token = document.getElementById('jwtToken').value || localStorage.getItem('jwt');
                if (!token) {
                    showResult('apiResult', 'âŒ JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤', {}, true);
                    return;
                }

                showResult('apiResult', 'API í˜¸ì¶œ ì‹œì‘...', { endpoint: '/api/appointments/1/confirm' });

                const response = await fetch('http://localhost:8080/api/appointments/1/confirm', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('apiResult', 'âœ… ì•½ì† í™•ì • API ì„±ê³µ', result);
                } else {
                    showResult('apiResult', 'âŒ ì•½ì† í™•ì • API ì‹¤íŒ¨', { 
                        status: response.status, 
                        result 
                    }, true);
                }

            } catch (error) {
                showResult('apiResult', 'âŒ API í˜¸ì¶œ ì˜¤ë¥˜', { 
                    error: error.message 
                }, true);
            }
        }

        // ì°¸ì—¬ì ì¡°íšŒ API í…ŒìŠ¤íŠ¸
        async function testGetParticipants() {
            try {
                const token = document.getElementById('jwtToken').value || localStorage.getItem('jwt');
                if (!token) {
                    showResult('apiResult', 'âŒ JWT í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤', {}, true);
                    return;
                }

                const response = await fetch('http://localhost:8080/api/appointments/1/participants', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('apiResult', 'âœ… ì°¸ì—¬ì ì¡°íšŒ API ì„±ê³µ', result);
                } else {
                    showResult('apiResult', 'âŒ ì°¸ì—¬ì ì¡°íšŒ API ì‹¤íŒ¨', { 
                        status: response.status, 
                        result 
                    }, true);
                }

            } catch (error) {
                showResult('apiResult', 'âŒ API í˜¸ì¶œ ì˜¤ë¥˜', { 
                    error: error.message 
                }, true);
            }
        }

        // í† í° ì—†ì´ API í˜¸ì¶œ
        async function testWithoutToken() {
            try {
                const response = await fetch('http://localhost:8080/api/appointments/1/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.text();
                
                showResult('apiResult', 'ğŸ”’ í† í° ì—†ëŠ” API í˜¸ì¶œ ê²°ê³¼', { 
                    status: response.status,
                    statusText: response.statusText,
                    body: result
                }, response.status !== 401);

            } catch (error) {
                showResult('apiResult', 'âŒ API í˜¸ì¶œ ì˜¤ë¥˜', { 
                    error: error.message 
                }, true);
            }
        }

        // ì˜ëª»ëœ í† í°ìœ¼ë¡œ API í˜¸ì¶œ
        async function testWithInvalidToken() {
            try {
                const response = await fetch('http://localhost:8080/api/appointments/1/confirm', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer invalid.token.here',
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.text();
                
                showResult('apiResult', 'ğŸ”’ ì˜ëª»ëœ í† í° API í˜¸ì¶œ ê²°ê³¼', { 
                    status: response.status,
                    statusText: response.statusText,
                    body: result
                }, response.status === 200); // 200ì´ë©´ ì˜¤ë¥˜ë¡œ í‘œì‹œ

            } catch (error) {
                showResult('apiResult', 'âŒ API í˜¸ì¶œ ì˜¤ë¥˜', { 
                    error: error.message 
                }, true);
            }
        }

        // í¬ë¡œìŠ¤ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸
        async function testCrossOrigin() {
            try {
                showResult('crossOriginResult', 'í¬ë¡œìŠ¤ ë„ë©”ì¸ ìš”ì²­ ì‹œì‘...', { 
                    from: 'localhost:8080',
                    to: 'localhost:8080',
                    simulation: 'UserServiceì—ì„œ í˜¸ì¶œí•˜ëŠ” ìƒí™© ì‹œë®¬ë ˆì´ì…˜'
                });

                // ì‹¤ì œ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Origin í—¤ë”ë¥¼ ì§ì ‘ ì„¤ì •í•  ìˆ˜ ì—†ì§€ë§Œ,
                // ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•´ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
                const token = document.getElementById('jwtToken').value || localStorage.getItem('jwt');
                
                const response = await fetch('http://localhost:8080/api/appointments/1/participants', {
                    method: 'GET',
                    headers: token ? {
                        'Authorization': 'Bearer ' + token
                    } : {}
                });

                const result = response.ok ? await response.json() : await response.text();
                
                showResult('crossOriginResult', 'âœ… í¬ë¡œìŠ¤ ë„ë©”ì¸ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ', { 
                    status: response.status,
                    cors_headers: {
                        'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                        'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                        'access-control-allow-headers': response.headers.get('access-control-allow-headers')
                    },
                    result: result
                });

            } catch (error) {
                showResult('crossOriginResult', 'âŒ í¬ë¡œìŠ¤ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', { 
                    error: error.message 
                }, true);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ í† í° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            const existingToken = localStorage.getItem('jwt');
            if (existingToken) {
                document.getElementById('jwtToken').value = existingToken;
            }
        });
    </script>
</body>
</html>






