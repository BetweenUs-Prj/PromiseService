<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ë¡œê·¸ì¸ ì™„ë£Œ - PromiseService</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 100px auto;
            padding: 20px;
            text-align: center;
            background: #f5f5f5;
        }
        .result-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .token-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            border-left: 4px solid #4CAF50;
        }
        .action-buttons {
            margin-top: 30px;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        .btn-primary:hover {
            background: #1976D2;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        #loadingMsg {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="result-container">
        <h2>ğŸ¯ PromiseService</h2>
        <div id="loadingMsg">ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</div>
        <div id="resultMsg" style="display: none;"></div>
        <div id="tokenInfo" style="display: none;"></div>
        <div id="actionButtons" class="action-buttons" style="display: none;"></div>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë¡œê·¸ì¸ ê²°ê³¼ í™•ì¸
        // ì´ìœ : UserServiceì—ì„œ OAuth2 ì„±ê³µ í›„ JWT í† í°ê³¼ í•¨ê»˜ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ ê²°ê³¼ë¥¼ ì²˜ë¦¬
        function processLoginResult() {
            const urlParams = new URLSearchParams(location.search);
            const success = urlParams.get('success') === 'true';
            const token = urlParams.get('token');
            const error = urlParams.get('error');

            const loadingMsg = document.getElementById('loadingMsg');
            const resultMsg = document.getElementById('resultMsg');
            const tokenInfo = document.getElementById('tokenInfo');
            const actionButtons = document.getElementById('actionButtons');

            // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            loadingMsg.style.display = 'none';
            resultMsg.style.display = 'block';
            actionButtons.style.display = 'block';

            if (success && token) {
                // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
                // ì´ìœ : JWT í† í°ì„ localStorageì— ì €ì¥í•˜ì—¬ ì´í›„ API í˜¸ì¶œì—ì„œ ì¸ì¦ í—¤ë”ë¡œ ì‚¬ìš©
                try {
                    localStorage.setItem('jwt', token);
                    
                    resultMsg.innerHTML = '<h3 class="success">âœ… ë¡œê·¸ì¸ ì„±ê³µ!</h3><p>ì¹´ì¹´ì˜¤ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                    
                    // í† í° ì •ë³´ í‘œì‹œ (ë””ë²„ê¹…ìš©)
                    tokenInfo.style.display = 'block';
                    tokenInfo.innerHTML = `
                        <strong>ì €ì¥ëœ JWT í† í°:</strong><br>
                        <div style="margin-top: 10px;">${token.substring(0, 50)}...</div>
                        <small style="color: #666;">í† í°ì´ localStorageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</small>
                    `;

                    // ì•¡ì…˜ ë²„íŠ¼ë“¤
                    actionButtons.innerHTML = `
                        <a href="/" class="btn btn-primary">ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™</a>
                        <button onclick="testAPI()" class="btn btn-secondary">API í…ŒìŠ¤íŠ¸</button>
                        <button onclick="clearToken()" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
                    `;

                    // 5ì´ˆ í›„ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    setTimeout(() => {
                        if (confirm('ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            location.href = '/';
                        }
                    }, 3000);

                } catch (e) {
                    console.error('í† í° ì €ì¥ ì‹¤íŒ¨:', e);
                    resultMsg.innerHTML = '<h3 class="error">âŒ í† í° ì €ì¥ ì‹¤íŒ¨</h3><p>ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í† í°ì„ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                }
                
            } else {
                // ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬
                resultMsg.innerHTML = `
                    <h3 class="error">âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨</h3>
                    <p>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    ${error ? `<p>ì˜¤ë¥˜: ${error}</p>` : ''}
                `;
                
                actionButtons.innerHTML = `
                    <a href="/login.html" class="btn btn-primary">ë‹¤ì‹œ ë¡œê·¸ì¸</a>
                    <a href="/" class="btn btn-secondary">ë©”ì¸ìœ¼ë¡œ</a>
                `;
            }

            // URL íŒŒë¼ë¯¸í„° ì •ë¦¬ (ë³´ì•ˆìƒ í† í°ì´ URLì— ë‚¨ì§€ ì•Šë„ë¡)
            // ì´ìœ : ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ì— JWT í† í°ì´ ë‚¨ëŠ” ê²ƒì„ ë°©ì§€í•˜ì—¬ ë³´ì•ˆì„± í–¥ìƒ
            if (token) {
                const cleanUrl = location.origin + location.pathname;
                history.replaceState(null, '', cleanUrl);
            }
        }

        // API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        // ì´ìœ : ë¡œê·¸ì¸ ì™„ë£Œ í›„ ì¦‰ì‹œ API ì—°ë™ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´
        async function testAPI() {
            try {
                const token = localStorage.getItem('jwt');
                if (!token) {
                    alert('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const response = await fetch('/api/appointments/1/confirm', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                alert('API í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n' + JSON.stringify(result, null, 2));

            } catch (error) {
                console.error('API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                alert('API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í† í° ì‚­ì œ (ë¡œê·¸ì•„ì›ƒ)
        // ì´ìœ : ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•  ìˆ˜ ìˆë„ë¡ localStorageì—ì„œ í† í° ì œê±°
        function clearToken() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('jwt');
                alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.href = '/login.html';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ê²°ê³¼ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', processLoginResult);
    </script>
</body>
</html>







